{{- $url := .Get "url" | default (.Get 0) -}}
{{- $title := .Get "title" | default "" -}}
{{- $description := .Get "description" | default "" -}}
{{- $image := .Get "image" | default "" -}}
{{- $siteName := .Get "site-name" | default "" -}}
{{- $fetch := .Get "fetch" | default "true" -}}

{{- $ogTitle := "" -}}
{{- $ogImage := "" -}}

{{- if eq $fetch "true" -}}
{{- with resources.GetRemote $url -}}
  {{- with .Content -}}
    {{- $content := . | string -}}

    {{- /* Extract og:title */ -}}
    {{- $titleRegex := `<meta[^>]+(?:property|name)="(?:og:title|twitter:title)"[^>]+content="([^"]+)"|<meta[^>]+content="([^"]+)"[^>]+(?:property|name)="(?:og:title|twitter:title)"` -}}
    {{- /* Closing quote for regex syntax " */ -}}
    {{- with findRE $titleRegex $content 1 -}}
      {{- with index . 0 -}}
        {{- $matches := findRE `content="([^"]+)"` . 1 -}}
        {{- /* Closing quote for regex syntax " */ -}}
        {{- with index $matches 0 -}}
          {{- $ogTitle = replaceRE `content="([^"]+)"` "$1" . -}}
          {{- /* Closing quote for regex syntax " */ -}}
        {{- end -}}
      {{- end -}}
      {{- end -}}

    {{- /* Fallback to <title> tag */ -}}
    {{- if not $ogTitle -}}
      {{- $titleTagRegex := `<title[^>]*>([^<]+)</title>` -}}
      {{- with findRE $titleTagRegex $content 1 -}}
        {{- with index . 0 -}}
          {{- $title = replaceRE `<title[^>]*>([^<]+)</title>` "$1" . | htmlUnescape -}}
        {{- end -}}
      {{- end -}}
    {{- else -}}
      {{- $title = $ogTitle -}}
    {{- end -}}

    {{- /* Extract og:description */ -}}
    {{- $descRegex := `<meta[^>]+(?:property|name)="(?:og:description|twitter:description|description)"[^>]+content="([^"]+)"|<meta[^>]+content="([^"]+)"[^>]+(?:property|name)="(?:og:description|twitter:description|description)"` -}}
    {{- /* Closing quote for regex syntax " */ -}}
    {{- with findRE $descRegex $content 1 -}}
      {{- with index . 0 -}}
        {{- $matches := findRE `content="([^"]+)"` . 1 -}}
        {{- /* Closing quote for regex syntax " */ -}}
        {{- with index $matches 0 -}}
          {{- $description = replaceRE `content="([^"]+)"` "$1" . -}}
          {{- /* Closing quote for regex syntax " */ -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- /* Extract og:image */ -}}
    {{- $imageRegex := `<meta[^>]+(?:property|name)="(?:og:image|twitter:image)"[^>]+content="([^"]+)"|<meta[^>]+content="([^"]+)"[^>]+(?:property|name)="(?:og:image|twitter:image)"` -}}
    {{- /* Closing quote for regex syntax " */ -}}
    {{- with findRE $imageRegex $content 1 -}}
      {{- with index . 0 -}}
        {{- $matches := findRE `content="([^"]+)"` . 1 -}}
        {{- /* Closing quote for regex syntax " */ -}}
        {{- with index $matches 0 -}}
          {{- $ogImage = replaceRE `content="([^"]+)"` "$1" . -}}
          {{- /* Closing quote for regex syntax " */ -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- /* Fallback to first meaningful image in content */ -}}
    {{- if not $ogImage -}}
      {{- $imgRegex := `<img[^>]+alt=["'][^"']*["'][^>]+src=["']([^"']+)["']|<img[^>]+src=["']([^"']+)["'][^>]+alt=["'][^"']*["']` -}}
      {{- with findRE $imgRegex $content 20 -}}
        {{- range . -}}
          {{- $srcMatch := findRE `src=["']([^"']+)["']` . 1 -}}
          {{- with index $srcMatch 0 -}}
            {{- $imgSrc := replaceRE `src=["']([^"']+)["']` "$1" . -}}
            {{- /* Convert relative URLs to absolute */ -}}
            {{- if hasPrefix $imgSrc "http" -}}
              {{- $image = $imgSrc -}}
            {{- else if hasPrefix $imgSrc "/" -}}
              {{- $parsedURL := urls.Parse $url -}}
              {{- $image = printf "%s://%s%s" $parsedURL.Scheme $parsedURL.Host $imgSrc -}}
            {{- else -}}
              {{- /* Handle relative paths including ../ */ -}}
              {{- $parsedURL := urls.Parse $url -}}
              {{- $basePath := path.Dir $parsedURL.Path -}}
              {{- /* Resolve ../ by going up directories */ -}}
              {{- $resolvedPath := $basePath -}}
              {{- $remainingPath := $imgSrc -}}
              {{- range seq 10 -}}
                {{- if hasPrefix $remainingPath "../" -}}
                  {{- $resolvedPath = path.Dir $resolvedPath -}}
                  {{- $remainingPath = strings.TrimPrefix "../" $remainingPath -}}
                {{- end -}}
              {{- end -}}
              {{- $image = printf "%s://%s%s/%s" $parsedURL.Scheme $parsedURL.Host $resolvedPath $remainingPath -}}
            {{- end -}}
            {{- break -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- else -}}
      {{- $image = $ogImage -}}
    {{- end -}}

    {{- /* Extract og:site_name */ -}}
    {{- $siteRegex := `<meta[^>]+property="og:site_name"[^>]+content="([^"]+)"|<meta[^>]+content="([^"]+)"[^>]+property="og:site_name"` -}}
    {{- /* Closing quote for regex syntax " */ -}}
    {{- with findRE $siteRegex $content 1 -}}
      {{- with index . 0 -}}
        {{- $matches := findRE `content="([^"]+)"` . 1 -}}
        {{- /* Closing quote for regex syntax " */ -}}
        {{- with index $matches 0 -}}
          {{- $siteName = replaceRE `content="([^"]+)"` "$1" . -}}
          {{- /* Closing quote for regex syntax " */ -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- end -}}

<a href="{{ $url }}" target="_blank" class="bookmark-card">
  {{- if $image -}}
  <div class="bookmark-image">
    <img src="{{ $image }}" alt="{{ $title }}">
  </div>
  {{- end -}}
  <div class="bookmark-content">
    <h3 class="bookmark-title">
      {{- if $title -}}
        {{ $title | truncate 80 }}
      {{- else -}}
        {{ $url }}
      {{- end -}}
    </h3>
    {{- if $description -}}
    <p class="bookmark-description">
      {{ $description | truncate 120 }}
    </p>
    {{- end -}}
    <small class="bookmark-url">
      {{- if $siteName -}}
        {{ $siteName }}
      {{- else -}}
        {{ $url | replaceRE "^https?://([^/]+).*" "$1" }}
      {{- end -}}
    </small>
  </div>
</a>