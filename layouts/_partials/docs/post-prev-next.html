{{ $currentCategories := .Params.categories }}
{{ $currentPage := . }}

{{/* Concat current page categories to string for comparison */}}
{{ $currentCategoryStr := "" }}
{{ if reflect.IsSlice $currentCategories }}
  {{ $currentCategoryStr = delimit $currentCategories "/" }}
{{ else }}
  {{ $currentCategoryStr = $currentCategories }}
{{ end }}

{{/* Initialize empty slice to collect pages with matching categories */}}
{{ $pages := slice }}

{{ range where .Site.RegularPages "Section" .Section }}
  {{ $pageCategories := .Params.categories }}

  {{ if and $currentCategories $pageCategories }}

    {{/* Concat iterated page categories to string for comparison */}}
    {{ $pageCategoryStr := "" }}
    {{ if reflect.IsSlice $pageCategories }}
      {{ $pageCategoryStr = delimit $pageCategories "/" }}
    {{ else }}
      {{ $pageCategoryStr = $pageCategories }}
    {{ end }}

    {{/* Match pages with identical category strings */}}
    {{ if eq $currentCategoryStr $pageCategoryStr }}
      {{ $pages = $pages | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Initialize prev/next page references */}}
{{ $prev := "" }}
{{ $next := "" }}
{{ $matches := false }}

{{/* Find current page position in filtered pages to determine adjacent pages */}}
{{ range $index, $page := $pages }}
  {{ if eq $page.RelPermalink $currentPage.RelPermalink }}
    {{ $matches = true }}

    {{/* Set previous page if not at the beginning of the collection */}}
    {{ if gt $index 0 }}
      {{ $prev = index $pages (sub $index 1) }}
    {{ end }}

    {{/* Set next page if not at the end of the collection */}}
    {{ if lt $index (sub (len $pages) 1) }}
      {{ $next = index $pages (add $index 1) }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="post-navigation">
  {{ with $prev }}
  <a href="{{ .RelPermalink }}" class="post-nav-link post-nav-prev">
    <span class="post-nav-direction"><i class="fa-solid fa-backward"></i> PREV</span>
    <span class="post-nav-title">{{ partial "docs/title" . }}</span>
  </a>
  {{ else }}
  <a href="" class="post-nav-link post-nav-prev post-nav-disabled">
    <span class="post-nav-direction"><i class="fa-solid fa-backward"></i> PREV</span>
    <span class="post-nav-title">이전 게시글이 없습니다</span>
  </a>
  {{ end }}

  {{ with $next }}
  <a href="{{ .RelPermalink }}" class="post-nav-link post-nav-next">
    <span class="post-nav-direction">NEXT <i class="fa-solid fa-forward"></i></span>
    <span class="post-nav-title">{{ partial "docs/title" . }}</span>
  </a>
  {{ else }}
  <a href="" class="post-nav-link post-nav-next post-nav-disabled">
    <span class="post-nav-direction">NEXT <i class="fa-solid fa-forward"></i></span>
    <span class="post-nav-title">다음 게시글이 없습니다</span>
  </a>
  {{ end }}
</div>